{
  "version": 3,
  "sources": ["../../../../../src/lib/tools/SelectTool/childStates/PointingArrowLabel.ts"],
  "sourcesContent": ["import {\n\tArc2d,\n\tGeometry2d,\n\tGroup2d,\n\tStateNode,\n\tTLArrowShape,\n\tTLEventHandlers,\n\tTLPointerEventInfo,\n\tTLShapeId,\n\tVec,\n\tgetPointInArcT,\n} from '@tldraw/editor'\nimport { getArrowInfo } from '../../../shapes/arrow/shared'\n\nexport class PointingArrowLabel extends StateNode {\n\tstatic override id = 'pointing_arrow_label'\n\n\tshapeId = '' as TLShapeId\n\tmarkId = ''\n\twasAlreadySelected = false\n\tdidDrag = false\n\n\tprivate info = {} as TLPointerEventInfo & {\n\t\tshape: TLArrowShape\n\t\tonInteractionEnd?: string\n\t\tisCreating: boolean\n\t}\n\n\tprivate updateCursor() {\n\t\tthis.editor.setCursor({ type: 'grabbing', rotation: 0 })\n\t}\n\n\toverride onEnter = (\n\t\tinfo: TLPointerEventInfo & {\n\t\t\tshape: TLArrowShape\n\t\t\tonInteractionEnd?: string\n\t\t\tisCreating: boolean\n\t\t}\n\t) => {\n\t\tconst { shape } = info\n\t\tthis.parent.setCurrentToolIdMask(info.onInteractionEnd)\n\t\tthis.info = info\n\t\tthis.shapeId = shape.id\n\t\tthis.didDrag = false\n\t\tthis.wasAlreadySelected = this.editor.getOnlySelectedShapeId() === shape.id\n\t\tthis.updateCursor()\n\n\t\tconst geometry = this.editor.getShapeGeometry<Group2d>(shape)\n\t\tconst labelGeometry = geometry.children[1]\n\t\tif (!labelGeometry) {\n\t\t\tthrow Error(`Expected to find an arrow label geometry for shape: ${shape.id}`)\n\t\t}\n\t\tconst { currentPagePoint } = this.editor.inputs\n\t\tconst pointInShapeSpace = this.editor.getPointInShapeSpace(shape, currentPagePoint)\n\n\t\tthis._labelDragOffset = Vec.Sub(labelGeometry.center, pointInShapeSpace)\n\n\t\tthis.markId = 'label-drag start'\n\t\tthis.editor.mark(this.markId)\n\t\tthis.editor.setSelectedShapes([this.shapeId])\n\t}\n\n\toverride onExit = () => {\n\t\tthis.parent.setCurrentToolIdMask(undefined)\n\n\t\tthis.editor.setCursor({ type: 'default', rotation: 0 })\n\t}\n\n\tprivate _labelDragOffset = new Vec(0, 0)\n\n\toverride onPointerMove = () => {\n\t\tconst { isDragging } = this.editor.inputs\n\t\tif (!isDragging) return\n\n\t\tconst shape = this.editor.getShape<TLArrowShape>(this.shapeId)\n\t\tif (!shape) return\n\n\t\tconst info = getArrowInfo(this.editor, shape)!\n\n\t\tconst groupGeometry = this.editor.getShapeGeometry<Group2d>(shape)\n\t\tconst bodyGeometry = groupGeometry.children[0] as Geometry2d\n\t\tconst pointInShapeSpace = this.editor.getPointInShapeSpace(\n\t\t\tshape,\n\t\t\tthis.editor.inputs.currentPagePoint\n\t\t)\n\t\tconst nearestPoint = bodyGeometry.nearestPoint(\n\t\t\tVec.Add(pointInShapeSpace, this._labelDragOffset)\n\t\t)\n\n\t\tlet nextLabelPosition\n\t\tif (info.isStraight) {\n\t\t\t// straight arrows\n\t\t\tconst lineLength = Vec.Dist(info.start.point, info.end.point)\n\t\t\tconst segmentLength = Vec.Dist(info.end.point, nearestPoint)\n\t\t\tnextLabelPosition = 1 - segmentLength / lineLength\n\t\t} else {\n\t\t\tconst { _center, measure, angleEnd, angleStart } = groupGeometry.children[0] as Arc2d\n\t\t\tnextLabelPosition = getPointInArcT(measure, angleStart, angleEnd, _center.angle(nearestPoint))\n\t\t}\n\n\t\tif (isNaN(nextLabelPosition)) {\n\t\t\tnextLabelPosition = 0.5\n\t\t}\n\n\t\tthis.didDrag = true\n\t\tthis.editor.updateShape<TLArrowShape>({\n\t\t\tid: shape.id,\n\t\t\ttype: shape.type,\n\t\t\tprops: { labelPosition: nextLabelPosition },\n\t\t})\n\t}\n\n\toverride onPointerUp = () => {\n\t\tconst shape = this.editor.getShape<TLArrowShape>(this.shapeId)\n\t\tif (!shape) return\n\n\t\tif (this.didDrag || !this.wasAlreadySelected) {\n\t\t\tthis.complete()\n\t\t} else {\n\t\t\t// Go into edit mode.\n\t\t\tthis.editor.setEditingShape(shape.id)\n\t\t\tthis.editor.setCurrentTool('select.editing_shape')\n\t\t}\n\t}\n\n\toverride onCancel: TLEventHandlers['onCancel'] = () => {\n\t\tthis.cancel()\n\t}\n\n\toverride onComplete: TLEventHandlers['onComplete'] = () => {\n\t\tthis.cancel()\n\t}\n\n\toverride onInterrupt = () => {\n\t\tthis.cancel()\n\t}\n\n\tprivate complete() {\n\t\tif (this.info.onInteractionEnd) {\n\t\t\tthis.editor.setCurrentTool(this.info.onInteractionEnd, {})\n\t\t} else {\n\t\t\tthis.parent.transition('idle')\n\t\t}\n\t}\n\n\tprivate cancel() {\n\t\tthis.editor.bailToMark(this.markId)\n\n\t\tif (this.info.onInteractionEnd) {\n\t\t\tthis.editor.setCurrentTool(this.info.onInteractionEnd, {})\n\t\t} else {\n\t\t\tthis.parent.transition('idle')\n\t\t}\n\t}\n}\n"],
  "mappings": "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",
  "names": []
}
